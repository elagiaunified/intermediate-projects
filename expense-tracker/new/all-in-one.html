<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker - All in One</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/theme.css">
    <style>
        /* Emergency styles if CSS files fail */
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        [data-theme="dark"] .card { background: #2d2d2d; }
    </style>
</head>
<body>
    <!-- Same HTML as index.html, but we'll use a simplified version -->
    <div class="container">
        <header style="display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid #ddd;">
            <h1><i class="fas fa-wallet"></i> Expense Tracker</h1>
            <button id="theme-toggle">
                <i class="fas fa-moon"></i>
            </button>
        </header>
        
        <div class="card">
            <h2>Test Panel</h2>
            <button onclick="testClasses()">Test JavaScript Classes</button>
            <button onclick="testTheme()">Test Theme Toggle</button>
            <button onclick="testStorage()">Test LocalStorage</button>
            <div id="test-results" style="margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 5px;"></div>
        </div>
        
        <div class="card">
            <h2>Debug Console</h2>
            <div id="console" style="height: 200px; overflow-y: auto; background: #1e1e1e; color: #00ff00; padding: 10px; font-family: monospace;"></div>
        </div>
    </div>

    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- ALL JAVASCRIPT IN ONE FILE -->
    <script>
        console.log('=== Loading JavaScript Classes ===');
        
        // ===== StorageManager =====
        console.log('Defining StorageManager...');
        class StorageManager {
            constructor() {
                this.storageKey = 'expense-tracker-data';
                this.settingsKey = 'expense-tracker-settings';
            }
            
            saveExpenses(expenses) {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(expenses));
                    return true;
                } catch (error) {
                    console.error('Save error:', error);
                    return false;
                }
            }
            
            loadExpenses() {
                try {
                    const data = localStorage.getItem(this.storageKey);
                    return data ? JSON.parse(data) : [];
                } catch (error) {
                    console.error('Load error:', error);
                    return [];
                }
            }
            
            saveSettings(settings) {
                localStorage.setItem(this.settingsKey, JSON.stringify(settings));
            }
            
            loadSettings() {
                const data = localStorage.getItem(this.settingsKey);
                return data ? JSON.parse(data) : {};
            }
            
            clearAllData() {
                localStorage.removeItem(this.storageKey);
                localStorage.removeItem(this.settingsKey);
            }
        }
        console.log('StorageManager defined:', typeof StorageManager);
        
        // ===== CurrencyConverter =====
        console.log('Defining CurrencyConverter...');
        class CurrencyConverter {
            constructor() {
                this.apiUrl = 'https://api.exchangerate-api.com/v4/latest/';
                this.fallbackRates = {
                    USD: { USD: 1, EUR: 0.92, GBP: 0.79, JPY: 150, CAD: 1.35, AUD: 1.52, INR: 83 },
                    EUR: { USD: 1.09, EUR: 1, GBP: 0.86, JPY: 163, CAD: 1.47, AUD: 1.65, INR: 90 },
                    GBP: { USD: 1.27, EUR: 1.16, GBP: 1, JPY: 190, CAD: 1.71, AUD: 1.92, INR: 105 }
                };
            }
            
            async getExchangeRates(baseCurrency = 'USD') {
                try {
                    const response = await fetch(`${this.apiUrl}${baseCurrency}`);
                    const data = await response.json();
                    return data.rates || this.fallbackRates[baseCurrency];
                } catch (error) {
                    console.warn('Using fallback rates');
                    return this.fallbackRates[baseCurrency] || this.fallbackRates.USD;
                }
            }
            
            convertToBase(amount, fromCurrency, baseCurrency) {
                if (fromCurrency === baseCurrency) return amount;
                // Simplified conversion for demo
                if (baseCurrency === 'USD') {
                    const rates = { EUR: 0.92, GBP: 0.79, JPY: 150, CAD: 1.35, AUD: 1.52, INR: 83 };
                    return amount * (rates[fromCurrency] || 1);
                }
                return amount; // Simplified
            }
            
            getCurrencySymbol(currency) {
                const symbols = { USD: '$', EUR: '€', GBP: '£', JPY: '¥', CAD: 'C$', AUD: 'A$', INR: '₹' };
                return symbols[currency] || currency;
            }
        }
        console.log('CurrencyConverter defined:', typeof CurrencyConverter);
        
        // ===== ExpenseManager =====
        console.log('Defining ExpenseManager...');
        class ExpenseManager {
            constructor() {
                this.expenses = [];
                this.nextId = 1;
            }
            
            setExpenses(expenses) {
                this.expenses = expenses || [];
                const maxId = this.expenses.reduce((max, exp) => Math.max(max, exp.id || 0), 0);
                this.nextId = maxId + 1;
            }
            
            getExpenses() {
                return [...this.expenses];
            }
            
            addExpense(expenseData) {
                const expense = {
                    id: this.nextId++,
                    ...expenseData,
                    createdAt: new Date().toISOString()
                };
                this.expenses.push(expense);
                return expense;
            }
            
            deleteExpense(id) {
                const before = this.expenses.length;
                this.expenses = this.expenses.filter(exp => exp.id !== id);
                return this.expenses.length < before;
            }
            
            getTotalInBaseCurrency(baseCurrency) {
                if (!window.app?.currencyConverter) return 0;
                let total = 0;
                for (const exp of this.expenses) {
                    total += window.app.currencyConverter.convertToBase(exp.amount, exp.currency, baseCurrency);
                }
                return total;
            }
        }
        console.log('ExpenseManager defined:', typeof ExpenseManager);
        
        // ===== ChartManager =====
        console.log('Defining ChartManager...');
        class ChartManager {
            constructor() {
                this.chart = null;
            }
            
            init() {
                console.log('ChartManager initialized');
            }
        }
        console.log('ChartManager defined:', typeof ChartManager);
        
        // ===== ExpenseTrackerApp =====
        console.log('Defining ExpenseTrackerApp...');
        class ExpenseTrackerApp {
            constructor() {
                console.log('Creating ExpenseTrackerApp instance');
                this.expenseManager = new ExpenseManager();
                this.currencyConverter = new CurrencyConverter();
                this.chartManager = new ChartManager();
                this.storageManager = new StorageManager();
                this.currentBaseCurrency = 'USD';
                
                this.init();
            }
            
            init() {
                console.log('Initializing app');
                
                // Theme toggle
                const themeToggle = document.getElementById('theme-toggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', () => {
                        this.toggleTheme();
                    });
                }
                
                // Load saved theme
                const savedTheme = localStorage.getItem('expense-tracker-theme') || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
                
                const icon = document.querySelector('#theme-toggle i');
                if (icon) {
                    icon.className = savedTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
                }
                
                console.log('App initialized successfully');
            }
            
            toggleTheme() {
                const html = document.documentElement;
                const currentTheme = html.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('expense-tracker-theme', newTheme);
                
                const icon = document.querySelector('#theme-toggle i');
                if (icon) {
                    icon.className = newTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
                }
                
                console.log('Theme changed to:', newTheme);
            }
        }
        console.log('ExpenseTrackerApp defined:', typeof ExpenseTrackerApp);
        
        // ===== Test Functions =====
        function testClasses() {
            const results = document.getElementById('test-results');
            const classes = [
                { name: 'StorageManager', obj: StorageManager },
                { name: 'CurrencyConverter', obj: CurrencyConverter },
                { name: 'ExpenseManager', obj: ExpenseManager },
                { name: 'ChartManager', obj: ChartManager },
                { name: 'ExpenseTrackerApp', obj: ExpenseTrackerApp }
            ];
            
            let html = '<h3>Class Test Results:</h3>';
            let allPassed = true;
            
            classes.forEach(cls => {
                const isDefined = typeof cls.obj !== 'undefined';
                if (!isDefined) allPassed = false;
                
                html += `<div style="color: ${isDefined ? 'green' : 'red'}; margin: 5px 0;">
                    ${isDefined ? '✅' : '❌'} ${cls.name}: ${isDefined ? 'DEFINED' : 'NOT DEFINED'}
                </div>`;
            });
            
            if (allPassed) {
                html += '<div style="color: green; margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 5px;">
                    <strong>✅ ALL CLASSES LOADED SUCCESSFULLY!</strong>
                </div>';
                
                // Try to create an instance
                try {
                    window.app = new ExpenseTrackerApp();
                    html += '<div style="color: green; margin-top: 10px;">✅ App instance created successfully!</div>';
                } catch (error) {
                    html += `<div style="color: red; margin-top: 10px;">❌ Failed to create app: ${error.message}</div>`;
                }
            } else {
                html += '<div style="color: red; margin-top: 10px; padding: 10px; background: #ffebee; border-radius: 5px;">
                    <strong>❌ SOME CLASSES FAILED TO LOAD</strong>
                </div>';
            }
            
            results.innerHTML = html;
        }
        
        function testTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            
            const icon = document.querySelector('#theme-toggle i');
            if (icon) {
                icon.className = newTheme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
            }
            
            const results = document.getElementById('test-results');
            results.innerHTML = `<div style="color: green;">✅ Theme changed to: ${newTheme}</div>`;
        }
        
        function testStorage() {
            try {
                localStorage.setItem('test', 'test-value');
                const value = localStorage.getItem('test');
                localStorage.removeItem('test');
                
                const results = document.getElementById('test-results');
                if (value === 'test-value') {
                    results.innerHTML = '<div style="color: green;">✅ LocalStorage is working</div>';
                } else {
                    results.innerHTML = '<div style="color: orange;">⚠️ LocalStorage test value mismatch</div>';
                }
            } catch (error) {
                const results = document.getElementById('test-results');
                results.innerHTML = `<div style="color: red;">❌ LocalStorage error: ${error.message}</div>`;
            }
        }
        
        // Initialize console logging
        const consoleDiv = document.getElementById('console');
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            if (consoleDiv) {
                const message = args.map(arg => 
                    typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
                ).join(' ');
                consoleDiv.innerHTML += `> ${message}\n`;
                consoleDiv.scrollTop = consoleDiv.scrollHeight;
            }
        };
        
        console.log('=== All JavaScript Loaded ===');
        console.log('Ready to test! Click "Test JavaScript Classes"');
        
        // Auto-run tests after a short delay
        setTimeout(() => {
            testClasses();
        }, 1000);
    </script>
</body>
</html>
